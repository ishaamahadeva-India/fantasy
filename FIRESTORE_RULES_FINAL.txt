rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is super admin
    // Only admin@fantasy.com has admin access
    function isAdmin() {
      return isAuthenticated() && 
             request.auth.token.email == 'admin@fantasy.com';
    }
    
    // Users collection - users can read/write their own data, admin can read all
    match /users/{userId} {
      allow read: if isAuthenticated() && 
                    (request.auth.uid == userId || isAdmin());
      allow write: if isAuthenticated() && request.auth.uid == userId;
      allow create: if isAuthenticated();
      // Allow admin to update user engagement fields
      allow update: if isAdmin() || 
                      (isAuthenticated() && request.auth.uid == userId);
    }
    
    // Articles - public read, admin write
    match /articles/{articleId} {
      allow read: if true; // Public read
      allow write: if isAdmin();
    }
    
    // Gossips - public read, admin write
    match /gossips/{gossipId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Cricketers - public read, admin write
    match /cricketers/{cricketerId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Teams - public read, admin write
    match /teams/{teamId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Movies - public read, admin write
    match /movies/{movieId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Stars - public read, admin write
    match /stars/{starId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Fantasy Campaigns - authenticated read, admin write
    match /fantasy-campaigns/{campaignId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
      
      // Campaign Events subcollection - authenticated read, admin write
      match /events/{eventId} {
        allow read: if isAuthenticated();
        allow write: if isAdmin();
        
        // Event Predictions subcollection - authenticated users can create/read/update their own
        match /predictions/{predictionId} {
          allow read: if isAuthenticated();
          allow create: if isAuthenticated() && 
                         request.resource.data.userId == request.auth.uid;
          allow update: if isAuthenticated() && 
                         resource.data.userId == request.auth.uid &&
                         request.resource.data.userId == request.auth.uid;
          allow delete: if isAuthenticated() && 
                         resource.data.userId == request.auth.uid;
        }
      }
      
      // Campaign Participations subcollection - authenticated read/write
      match /participations/{participationId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update: if isAuthenticated() && 
                        resource.data.userId == request.auth.uid;
      }
    }
    
    // Fantasy Matches - authenticated read, admin write
    match /fantasy_matches/{matchId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Cricket Tournaments - authenticated read, admin write
    match /cricket-tournaments/{tournamentId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
      
      // Tournament Events subcollection - authenticated read, admin write
      match /events/{eventId} {
        allow read: if isAuthenticated();
        allow write: if isAdmin();
      }
      
      // Tournament Participations subcollection - authenticated read/write
      match /participations/{participationId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update: if isAuthenticated() && 
                        resource.data.userId == request.auth.uid;
      }
    }
    
    // User Predictions - users can read/write their own
    match /user-predictions/{predictionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
                      resource.data.userId == request.auth.uid;
    }
    
    // Tournament Entries - authenticated users can create, read own
    match /tournament-entries/{entryId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
                      resource.data.userId == request.auth.uid;
    }
    
    // Tournament Predictions - authenticated users can create, read own
    match /tournament-predictions/{predictionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
                      resource.data.userId == request.auth.uid;
    }
    
    // Campaign Entries - authenticated users can create, read own
    match /campaign-entries/{entryId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
                      resource.data.userId == request.auth.uid;
    }
    
    // Participations - authenticated users can create, read own
    match /participations/{participationId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
                      resource.data.userId == request.auth.uid;
    }
    
    // Team Eras - public read, admin write
    match /team-eras/{eraId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Performances - public read, admin write
    match /performances/{performanceId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Star Eras - public read, admin write
    match /star-eras/{eraId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Ratings - authenticated users can read/write their own, read all
    match /ratings/{ratingId} {
      allow read: if true; // Public read for average ratings
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && 
                      resource.data.userId == request.auth.uid &&
                      request.resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Advertisements - public read, admin write
    match /advertisements/{adId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Coupons collection
    match /coupons/{couponId} {
      allow read: if request.auth != null;
      allow create, update, delete: if isAdmin();
    }

    // Coupon redemptions collection
    match /coupon-redemptions/{redemptionId} {
      allow read: if isAdmin();
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAdmin();
    }
    
    // Image Advertisements - authenticated read, admin write
    match /image-advertisements/{adId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Image Ad Views - users can create their own views, read own views, admin can read all
    match /image-ad-views/{viewId} {
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() && 
                      request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && 
                      resource.data.userId == request.auth.uid;
      allow delete: if isAdmin();
    }
    
    // Image Ad Sponsors - authenticated read, admin write
    match /image-ad-sponsors/{sponsorId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Analytics Collections - Admin can read all, users can create/read their own
    
    // Quiz Attempts - users can create/read their own, admin can read all
    match /quiz_attempts/{attemptId} {
      allow create: if isAuthenticated() && 
                     request.resource.data.userId == request.auth.uid;
      allow read: if isAuthenticated() && 
                    (resource.data.userId == request.auth.uid || isAdmin());
      allow update: if isAuthenticated() && 
                      resource.data.userId == request.auth.uid;
      allow delete: if isAdmin();
    }
    
    // Brand Events - allow anonymous tracking, admin can read all
    match /brand_events/{eventId} {
      allow create: if true; // Allow anonymous tracking
      allow read: if isAdmin() || 
                    (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow update, delete: if isAdmin();
    }
    
    // Coupon Redemptions - users can create their own, admin can read all
    match /coupon_redemptions/{redemptionId} {
      allow create: if isAuthenticated() && 
                     request.resource.data.userId == request.auth.uid;
      allow read: if isAdmin() || 
                    (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow update, delete: if isAdmin();
    }
    
    // Sessions - allow anonymous tracking, admin can read all
    match /sessions/{sessionId} {
      allow create: if true; // Allow anonymous tracking
      allow read: if isAdmin() || 
                    (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow update: if isAuthenticated() && 
                      resource.data.userId == request.auth.uid;
      allow delete: if isAdmin();
    }
    
    // Analytics Events - allow anonymous tracking, admin can read all
    match /analytics_events/{eventId} {
      allow create: if true; // Allow anonymous tracking
      allow read: if isAdmin() || 
                    (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow update, delete: if isAdmin();
    }
    
    // Default: deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

